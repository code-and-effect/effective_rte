$(document).ready(function() {
  <% key = Rails.application.config.session_options[:key] %>
  var uploadify_script_data = {};
  var csrf_param = $('meta[name=csrf-param]').attr('content');
  var csrf_token = $('meta[name=csrf-token]').attr('content');
  uploadify_script_data[csrf_param] = encodeURI(encodeURIComponent(csrf_token));
  uploadify_script_data['<%= key %>'] = '<%= cookies[key] %>';

  $('#<%= target_div %>_uploadify.ready_for_uploadify').uploadify({
    uploader        : '/assets/uploadify.swf',
    script          : '/stylish_rte/assets',
    cancelImg       : '/assets/uploadify_cancel.png',
    auto            : true,
    multi           : true,
    removeCompleted : true,
    scriptData      : uploadify_script_data,
    onComplete      : function(event, ID, fileObj, response, data) {
      if(response == "error")
        alert("There was a server side error while uploading this file.  Please try again.");
      else {
        $.get('/stylish_rte/assets/show_asset_for_editor/' + response + '/' + '<%= htmlarea %>', function(data) {
          $('#<%= target_div %> > .assets').prepend(data);
        });
      }
    },
    onError: function (a, b, c, d) {
      alert('error ' + d.type + ' ' + d.status);
    },
  });

  $('#<%= target_div %>_uploadify.ready_for_uploadify').removeClass('ready_for_uploadify');

});
